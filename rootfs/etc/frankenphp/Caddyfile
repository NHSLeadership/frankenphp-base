{
    auto_https off
    skip_install_trust
    admin :2019
    metrics

    log {
        output stderr
        format json
        level INFO
    }
}

:8080 {
    root * /app
    log {
        output stdout
        format json
    }
    header {
        -X-Powered-By
        -Server
        x-nhsla-pod "{system.hostname}"
        x-nhsla-site "{env.APP_NAME}"
    }
    
    # Block version control directories
    @vcs path_regexp ^/\.(git|svn|hg|bzr|cvs)(/.*)?$
    handle @vcs {
        error 404
    }
    # Block Node.js/npm files and directories
    @nodejs path_regexp (?i)/(node_modules|npm-debug\.log|package-lock\.json|yarn\.lock|\.npm|\.node_gyp|\.yarn-cache)(/|$)
    handle @nodejs {
        error 404
    }
    
    # Block sensitive file extensions
    @sensitive_files path_regexp \.(bak|backup|dist|conf|config|yaml|yml|cfg|fla|ini|inc|log|psd|sh|bash|sql|~|orig|tmp|old|swp|swo|DS_Store)$
    handle @sensitive_files {
        error 404
    }
    
    # Block PHP/Composer files
    @php_files path_regexp (?i)(composer\.(json|lock)|phpunit\.xml|\.env|\.env\..*|web\.config|\.htaccess|\.user\.ini)$
    handle @php_files {
        error 404
    }

    # Block documentation and config files
    @docs path_regexp (?i)(readme.*|README.*|changelog.*|CHANGELOG.*|license.*|LICENSE.*|.*\.md|upgrade\.txt|UPGRADE.*|gulpfile\.js|webpack\.config\.js|tsconfig\.json|\.editorconfig|\.gitignore|\.dockerignore)$
    handle @docs {
        error 404
    }
    
    # Block vendor and development directories
    @dev_dirs path_regexp (?i)/(vendor|behat|tests|test|spec|build|dist|tmp|temp)(/|$)
    handle @dev_dirs {
        error 404
    }

    # Custom error pages from separate directory
    handle_errors {
        @403 expression {http.error.status_code} == 403
        @404 expression {http.error.status_code} == 404
        @500 expression {http.error.status_code} == 500
        @502 expression {http.error.status_code} == 502
        @504 expression {http.error.status_code} == 504
        
        handle @403 {
            root * /etc/frankenphp/errors
            rewrite * /403.html
            file_server
        }
        handle @404 {
            root * /etc/frankenphp/errors
            rewrite * /404.html
            file_server
        }
        handle @500 {
            root * /etc/frankenphp/errors
            rewrite * /500.html
            file_server
        }
        handle @502 {
            root * /etc/frankenphp/errors
            rewrite * /502.html
            file_server
        }
        handle @504 {
            root * /etc/frankenphp/errors
            rewrite * /504.html
            file_server
        }
    }

    php_server
}

:9253 {
    handle /metrics {
        metrics
    }
    handle /health {
        respond "OK" 200
    }
}